var SVG_LB_LOGO = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><g style="isolation:isolate"><g id="Layer_1" data-name="Layer 1"><path fill="#3e21ee" class="cls-2" d="M331.36 252.63a31.24 31.24 0 0 1-22.11-9.16l-62.54-62.55a31.27 31.27 0 0 1 44.21-44.23l40.44 40.44L458.7 49.8A31.27 31.27 0 0 1 502.92 94L353.47 243.42a31.2 31.2 0 0 1-22.11 9.21" /><path fill="#3e21ee" class="cls-2" d="M408.35 222.33c3.76 73.56-37.33 145.26-108.18 176.32-91.2 40-197.66-2.34-237.31-94.3a182 182 0 0 1-2.41-139.15 179.46 179.46 0 0 1 301.21-55.55l33.68-34.52a227.3 227.3 0 0 0-83.47-57.26 224.87 224.87 0 0 0-174.58 3.05A227.63 227.63 0 0 0 16 147.54a230 230 0 0 0 214.46 314.34 225.3 225.3 0 0 0 88.77-19.06c102.6-45 155.84-157.34 131.08-263.48Z"/><path fill="#3e21ee" d="m379.42 394.43 91.97 91.97"/><path fill="#3e21ee" class="cls-2" d="M471.39 510.28a23.8 23.8 0 0 1-16.88-7l-92-92a23.87 23.87 0 0 1 33.76-33.75l92 92a23.88 23.88 0 0 1-16.88 40.75"/><path fill="#3e21ee" class="cls-4" d="M253.48 299.7a6.3 6.3 0 0 0 1.61.2 6.69 6.69 0 0 0 6.49-5.09 259.2 259.2 0 0 0 7-54.84l-14.33-14.33a19.7 19.7 0 0 1 1.17 6.49 250.2 250.2 0 0 1-6.86 59.47 6.67 6.67 0 0 0 4.92 8.1M68.24 256.65c2-3.84 4.43-11.2 4.43-24.52 0-84.82 69-153.82 153.81-153.82A153.4 153.4 0 0 1 341.33 130l9.76-9.75A165.94 165.94 0 0 0 230.8 65h-3.94A166.51 166.51 0 0 0 63.3 260.37l1.5-.62a6.64 6.64 0 0 0 3.44-3.1"/><path fill="#3e21ee" class="cls-4" d="M81.74 282.56c4.57-2.55 19.46-13.73 19.46-50.43a127.6 127.6 0 0 1 3.55-29.91 6.69 6.69 0 1 0-13-3.16 141 141 0 0 0-3.92 33.07c0 28.64-10.12 37.07-12.24 38.52-3.15 1.12-6.22 2.35-9.2 3.74q1.74 6.56 4 12.88A100 100 0 0 1 80.67 283a5.4 5.4 0 0 0 1.07-.44m64.7-66.84a6.69 6.69 0 1 0 13.13 2.53 73.56 73.56 0 0 1 51.88-56.7 57.5 57.5 0 0 1 1-14 86.92 86.92 0 0 0-66.01 68.17m138.13-112.23a140.31 140.31 0 0 0-171 47.62 6.69 6.69 0 1 0 10.91 7.74 125.92 125.92 0 0 1 120.88-52.55 57.3 57.3 0 0 1 23.45-5 58 58 0 0 1 15.76 2.19"/><path fill="#3e21ee" class="cls-4" d="M172 285.66a6.67 6.67 0 0 0 8.29-4.56 176.4 176.4 0 0 0 6.49-49 46.84 46.84 0 0 1 32.32-44.47 57 57 0 0 1-5.37-12.26 60.2 60.2 0 0 0-40.32 56.73 162.6 162.6 0 0 1-6 45.24 6.71 6.71 0 0 0 4.59 8.32m-79.34 22.15c6.19-2.49 37.07-17.88 37.07-75.68a99.93 99.93 0 0 1 70.52-95.81 6.68 6.68 0 1 0-4-12.76 113.23 113.23 0 0 0-79.91 108.57c0 49.38-24.88 61.68-28.53 63.22a82.4 82.4 0 0 0-12.08 5.1c1.84 4.06 3.85 8 6 11.91A72 72 0 0 1 92.25 308a4 4 0 0 0 .41-.19"/><path fill="#3e21ee" class="cls-4" d="M208.65 238.82a6.7 6.7 0 0 0 6.69-6.69 20.06 20.06 0 0 1 20.06-20.06 19.7 19.7 0 0 1 6.49 1.17l-13.73-13.74A33.48 33.48 0 0 0 202 232.13a6.7 6.7 0 0 0 6.65 6.69m122.72 40.07c-1.4 0-2.79-.11-4.18-.21-5.86 43.13-19.34 78.32-35.74 106.32a163 163 0 0 0 20.9-10.56c13.21-26.71 23.65-58.7 28.43-96.44a58 58 0 0 1-9.41.89M298 325.81a6.71 6.71 0 0 0-8.54 4.06 239.8 239.8 0 0 1-35.53 65.81 158 158 0 0 0 19.6-4.39A254.8 254.8 0 0 0 302 334.35a6.69 6.69 0 0 0-4-8.54M290.67 262l-11-11c-4.48 71.67-33.76 118.38-60.92 146.55 2.8.15 5.6.22 8.43.22 3.27 0 6.51-.09 9.72-.29 24.68-28.72 49-72.09 55.24-134.15-.47-.41-.99-.83-1.47-1.33m88.93-7.57a379 379 0 0 1-7.6 59.09 165.6 165.6 0 0 0 21.34-72.84Zm-26.74 20.22c-3.69 32.9-11.44 61.76-21.69 86.73a166.3 166.3 0 0 0 21.73-20.88 347 347 0 0 0 14.29-74.21 57.8 57.8 0 0 1-14.33 8.36m-188.69 41.88a6.69 6.69 0 0 0-11.17-7.34c-18.53 28.14-43.21 36.43-44.19 36.75-.59.18-1.16.39-1.73.61 3.39 3.55 7 7 10.7 10.23 9.42-4.13 30-15.39 46.39-40.25"/><path fill="#3e21ee" class="cls-4" d="M246 322a6.7 6.7 0 0 0-8.83 3.41 183.2 183.2 0 0 1-41.36 59.15c-3.1 3-6.2 5.69-9.27 8.24a163 163 0 0 0 16.46 3.27c.66-.61 1.3-1.21 2-1.84a196 196 0 0 0 44.37-63.43A6.67 6.67 0 0 0 246 322m-88.66-72a6.69 6.69 0 0 0-13.3-1.41c-6.16 57.65-43.87 71.4-45.3 71.92a58 58 0 0 0-9.51 4c2.54 3.74 5.23 7.4 8.08 10.93a43 43 0 0 1 5.66-2.23c1.92-.7 47.33-17.21 54.37-83.21m48.1 46.27a182 182 0 0 0 7.65-32.08 6.69 6.69 0 1 0-13.23-1.93 169.3 169.3 0 0 1-7.08 29.7c-15.3 44.87-46 66-62.74 74.56 4.06 2.94 8.29 5.69 12.62 8.24 19.39-11.45 47.92-34.86 62.78-78.49"/><path fill="#3e21ee" class="cls-4" d="M242.09 232.13a6.69 6.69 0 0 0-13.38 0c0 55.6-17.14 100.2-50.9 132.59A152.6 152.6 0 0 1 156.24 382c4.76 2.27 9.64 4.28 14.65 6.09a168 168 0 0 0 15.66-13.2c25.34-24.12 55.54-68.43 55.54-142.76"/></g></g></svg>`;

var renderCookieConsent = async () => {
  const showPreferences = lbCookieConsent.isPrefCenterOnly;
  const VISITOR_ID = "_lb_fp";
  let domain;
  let enableLightbeamBranding = true; // show logo by default

  const cookieConsentTypes = {
    accept: "accept",
    reject: "reject",
    acceptReject: "accept-reject",
    doNotSell: "do-not-sell",
    acceptDoNotSell: "accept-do-not-sell",
    rejectDoNotSell: "reject-do-not-sell",
  };

  const apiEventTypes = {
    accept: "accept-all",
    reject: "reject-all",
    doNotSell: "do-not-sell",
    customize: "customize",
  };

  const defaultConsentModes = {
    reject: "reject-all",
    accept: "accept-all",
  };

  /**
   * buttonName: "accept" | "reject" | "doNotSell"
   * consentType: cookieConsentTypes
   */
  const showButton = ({ buttonName = "", consentType = "" }) => {
    if (
      buttonName === "accept" &&
      (consentType === cookieConsentTypes.accept ||
        consentType === cookieConsentTypes.acceptReject ||
        consentType === cookieConsentTypes.acceptDoNotSell)
    ) {
      return true;
    }

    if (
      buttonName === "reject" &&
      (consentType === cookieConsentTypes.reject ||
        consentType === cookieConsentTypes.acceptReject ||
        consentType === cookieConsentTypes.rejectDoNotSell)
    ) {
      return true;
    }

    if (
      buttonName === "doNotSell" &&
      (consentType === cookieConsentTypes.doNotSell ||
        consentType === cookieConsentTypes.acceptDoNotSell ||
        consentType === cookieConsentTypes.rejectDoNotSell)
    ) {
      return true;
    }

    return false;
  };

  // utils
  const cleanUrlString = (domain) =>
    domain.replace(/https?:\/\//i, "").replace(/^(\.+)/g, "");

  const padTo2Digits = (num) => {
    return String(num).padStart(2, "0");
  };
  const getPrettyExpires = (expires = 0) => {
    if (!expires) return "--";
    const date = new Date(expires * 1000);

    const day = date.getDate();
    const months = [
      "Jan",
      "Feb",
      "Mar",
      "Apr",
      "May",
      "Jun",
      "Jul",
      "Aug",
      "Sep",
      "Oct",
      "Nov",
      "Dec",
    ];
    const month = date.getMonth();
    const year = date.getFullYear();
    const hours = padTo2Digits(date.getHours());
    const minutes = padTo2Digits(date.getMinutes());

    return `${day} ${months[month]} ${year}, ${hours}:${minutes}`;
  };
  const getBrowserName = () => {
    let userAgentString = navigator.userAgent;
    let chromeAgent = userAgentString.indexOf("Chrome") > -1;
    let IExplorerAgent =
      userAgentString.indexOf("MSIE") > -1 ||
      userAgentString.indexOf("rv:") > -1;
    let firefoxAgent = userAgentString.indexOf("Firefox") > -1;
    let safariAgent = userAgentString.indexOf("Safari") > -1;

    // Discard Safari since it also matches Chrome
    if (chromeAgent && safariAgent) safariAgent = false;

    let operaAgent = userAgentString.indexOf("OP") > -1;
    if (chromeAgent && operaAgent) chromeAgent = false;

    return operaAgent
      ? "Opera"
      : safariAgent
      ? "Safari"
      : firefoxAgent
      ? "Firefox"
      : IExplorerAgent
      ? "IE"
      : chromeAgent
      ? "Chrome"
      : "";
  };
  const isMobile = () => {
    const regex =
      /Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
    return regex.test(window.navigator?.userAgent);
  };
  const getBrowserLang = () => {
    return window.navigator?.language || "";
  };

  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  };

  const getUnique = (data = [], key = "") => {
    let unique = [];

    if (key) {
      data.forEach((elem) => {
        if (!unique.find((uniqueElem) => uniqueElem[key] === elem[key])) {
          unique.push(elem);
        }
      });
    } else {
      unique = [...new Set([...data])];
    }

    return unique;
  };

  const savePreferencesInStorage = (categoriesAccepted) => {
    setLbCookies({
      name: LB_LOCAL_STORAGE_PREFERENCES_KEY,
      value: { categoriesAccepted },
      shareCookies: domain.shareConsent,
    });
  };

  const saveScriptSettingsInStorage = (scriptSettings) => {
    setLbCookies({
      name: LB_LOCAL_STORAGE_SCRIPT_SETTINGS_KEY,
      value: scriptSettings,
    });
  };

  /**
   * Unblocks both scripts and iframes
   */
  const unblockSources = (regexp = "") => {
    window.yett?.unblock(regexp);
    window.lbIframeHandle?.unblock(regexp);
  };

  /**
   * Unblock essentials after page change
   */
  const enableEssentials = () => {
    if (domain.banner.defaultConsentMode === defaultConsentModes.accept) {
      unblockSources();
      return;
    }

    let domainsAccepted = getLbEssentialsWhiteList();
    domainsAccepted.forEach((domain) => {
      const regex = new RegExp(domain);
      unblockSources(regex);
    });
  };

  /**
   * Calculates user accepted/rejected consents taking into account mandatory essentials
   * @param {props} { isDoNotSell?: boolean, isSavePreferences?: boolean }
   * @returns
   */
  const getConsentData = (props = {}) => {
    const { isDoNotSell = false, isSavePreferences = false } = props;
    // get mandatory that must be accepted (optOut disabled)
    const categoriesAccepted = domain.categories?.filter((c) => !c.optOut);

    let domainsAccepted = window.lbCookieConsent?.isLoadedViaGtm
      ? []
      : essentialsWhiteList || [];
    const domainsAcceptedRegExp = domainsAccepted.map((domain) => {
      const regex = new RegExp(domain);
      unblockSources(regex);
      return regex;
    });

    const cookiesAccepted = domain?.cookies.filter((cookie) => {
      const isMandatory = !!categoriesAccepted.find(
        (cat) => cat.id === cookie.cookieCategoryId
      );
      console.log("isMandatory", isMandatory);
      if (isMandatory) {
        categoriesAccepted.find((cat) => cat.id === cookie.cookieCategoryId);
      }

      let isInEssentialDomains = false;
      domainsAcceptedRegExp.forEach((regExp) => {
        if (cookie.domain.match(regExp)) {
          isInEssentialDomains = true;
        }
      });

      const isAccepted = isMandatory || isInEssentialDomains;

      if (isAccepted) {
        domainsAccepted.push(cookie.domain);
      }

      return isAccepted;
    });

    console.log("cookiesAccepted", cookiesAccepted);

    // get optional accepted by user
    if (isDoNotSell) {
      // accept categories which is not selling user data
      domain?.categories.forEach((category) => {
        if (!category.doNotSell) {
          categoriesAccepted.push(category);

          domain?.cookies.forEach((cookie) => {
            if (cookie.cookieCategoryId === category.id) {
              cookiesAccepted.push(cookie);
              domainsAccepted.push(cleanUrlString(cookie.domain));
            }
          });
        }
      });
    }

    if (isSavePreferences) {
      // accept categories that user marked as "allowed"
      document.querySelectorAll(".category.accepted").forEach((elem) => {
        const category = domain?.categories?.find((c) => c.id === elem.id);
        category && categoriesAccepted.push(category);
        domain?.cookies.forEach((cookie) => {
          if (cookie.cookieCategoryId === elem.id) {
            domainsAccepted.push(cleanUrlString(cookie.domain));
            cookiesAccepted.push(cookie);
          }
        });
      });
    }

    // calculate rejected data
    const cookiesRejected = domain.cookies.filter(
      (c) => !cookiesAccepted.find((accepted) => accepted.id === c.id)
    );

    const categoriesRejected = domain.categories.filter(
      (c) => !categoriesAccepted.find((accepted) => accepted.id === c.id)
    );

    const domainsRejected = domain.cookies
      .filter((c) => !cookiesAccepted.find((accepted) => accepted.id === c.id))
      .map((cookie) => cookie.domain);

    // return unique data
    return {
      categoriesAccepted: getUnique(categoriesAccepted, "id"),
      categoriesRejected: getUnique(categoriesRejected, "id"),
      cookiesAccepted: getUnique(cookiesAccepted, "name"),
      cookiesRejected: getUnique(cookiesRejected, "name"),
      domainsAccepted: getUnique(domainsAccepted),
      domainsRejected: getUnique(domainsRejected),
    };
  };

  // API requests
  const fetchDomainInfo = async () => {
    const hostingUrlBase = lbCookieConsent.getHostingBaseUrl();

    const globalResponse = await fetch(
      `${hostingUrlBase}/domain_config_${domainHash}.json`
    );
    const globalDomain = await globalResponse.json();

    // get global banner
    const globalBanner = !!globalDomain?.regionBannerInfo.length
      ? globalDomain?.regionBannerInfo[0].banner
      : globalDomain?.banner;

    globalBanner.showBanner = !!globalDomain?.regionBannerInfo.length
      ? globalDomain?.regionBannerInfo[0].showBanner
      : true;
    globalBanner.defaultConsentMode = !!globalDomain?.regionBannerInfo.length
      ? globalDomain?.regionBannerInfo[0].defaultConsentMode
      : defaultConsentModes.reject;

    // get location-based banner
    let localBanner;
    try {
      const MAX_PENDING_TIME_MS = 2000;
      const controller = new AbortController();

      const webAppResponse = await Promise.race([
        fetch(
          `${dataWebApp}/api/cookie-consent/domain?domainName=${dataDomain}`,
          {
            signal: controller.signal,
          }
        ),
        new Promise((resolve) => {
          setTimeout(() => {
            resolve(JSON.stringify({ banner: null }));
            controller.abort();
          }, MAX_PENDING_TIME_MS);
        }),
      ]);
      const localDomain = await webAppResponse.json();
      localBanner = localDomain?.banner;
      enableLightbeamBranding = localDomain?.enableLightbeamBranding ?? true;
    } catch (e) {
      console.log("web app is not available");
    }

    const banner = localBanner || globalBanner;
    const domain = {
      ...globalDomain,
      banner: { ...banner, layout: {} },
    };

    let layout = {};

    try {
      layout = JSON.parse(banner.rawJSON);
    } catch (e) {
      return console.log("Cannot parse banner JSON");
    }

    const domainFinal = { ...domain, banner: { ...banner, layout } };
    return domainFinal;
  };

  const fetchPreferences = async () => {
    const response = await fetch(`${dataWebApp}/api/cookie-consent/response`, {
      credentials: "include",
    });
    const savedPreferences = await response.json();
    savePreferencesInStorage(savedPreferences?.consentInfo?.categoriesAccepted);
    return savedPreferences.consentInfo;
  };

  const postCookieConsent = ({
    consentAccepted,
    consentRejected,
    categoriesAccepted,
    categoriesRejected,
    eventType,
    headers = {},
  }) => {
    if (!domain) return;

    /**
     * Mapping gtag consents
     * GTM should be enabled on page, and either script was loaded wia GTM or gcm flag is on
     */
    if (
      window.gtag &&
      (!!window.lbCookieConsent?.isGcmOn ||
        !!window.lbCookieConsent?.isLoadedViaGtm)
    ) {
      const gtagConsents = {
        ad_storage: "denied",
        ad_user_data: "denied",
        ad_personalization: "denied",
        analytics_storage: "denied",
        personalization_storage: "denied",
        functionality_storage: "denied",
        security_storage: "denied",
      };

      // if GCM flag enabled, check send consent to google based on category mapping
      if (window.lbCookieConsent?.isGcmOn) {
        domain.googleConsentMapper.forEach((item) => {
          // if any of linked LB categories rejected, rejected the whole Google consent type
          const isGranted = item.lbCookieCategories.every((c) => {
            return !!categoriesAccepted.includes(c.id);
          });

          if (isGranted) {
            gtagConsents[item.googleConsentType] = "granted";
          }
        });
        lbCookieConsent.setConsentMode(gtagConsents);
      } else {
        // send all granted only if eventType is "accept all"
        if (eventType === apiEventTypes.accept) {
          Object.keys(gtagConsents).forEach((key) => {
            gtagConsents[key] = "granted";
          });
        }
        lbCookieConsent.setConsentMode(gtagConsents);
      }
    }

    fetch(`${dataWebApp}/api/cookie-consent/response`, {
      method: "POST",
      credentials: "include",
      body: JSON.stringify({
        status: "active",
        domain: dataDomain,
        networkIP: "",
        networkFamily: "",
        browserFingerprint: {
          device: isMobile() ? "mobile" : "desktop",
          browser: getBrowserName(),
          location: getBrowserLang(),
        },
        browserVisitorId: getCookie(VISITOR_ID) || "",
        consentInfo: {
          consentAccepted,
          consentRejected,
          categoriesAccepted,
          categoriesRejected,
        },
        eventType,
      }),
      headers,
    });
  };

  const postScriptSettings = (settings) => {
    fetch(`${dataWebApp}/api/cookie-consent/script-settings`, {
      method: "POST",
      credentials: "include",
      body: JSON.stringify(settings),
    });
  };

  const updateScriptSettings = (domain) => {
    const settings = {
      domainId: domain.id,
      domain: domain.domain,
      bannerId: domain.banner.id,
      subdomains: domain.subDomains,
      shareConsent: domain.shareConsent,
      googleConsentModeEnabled: !!window.lbCookieConsent?.isGcmOn,
      websiteIntegratedScriptVersion: ccVersion,
      websiteIntegrationMode: lbCookieConsent.isLoadedViaGtm
        ? "GTM"
        : "WebScript",
    };

    const settingsFromStorage = getLbCookies(
      LB_LOCAL_STORAGE_SCRIPT_SETTINGS_KEY
    );

    const isSameSettings =
      settings.domainId === settingsFromStorage?.domainId &&
      settings.websiteIntegratedScriptVersion ===
        settingsFromStorage?.websiteIntegratedScriptVersion &&
      settings.websiteIntegrationMode ===
        settingsFromStorage?.websiteIntegrationMode;

    if (!isSameSettings) {
      saveScriptSettingsInStorage(settings);
      postScriptSettings(settings);
    }
  };

  // DOM handlers
  const initHandlers = () => {
    document.addEventListener("click", function (e) {
      if (e.target?.id === "lb-cookie-consent-accept-all") {
        unblockSources();
        setLbCookies({
          name: LB_LOCAL_STORAGE_KEY,
          value: { blackList: [] },
          shareCookies: domain.shareConsent,
        });
        const consentAccepted = domain.cookies.map((c) => c.name);
        savePreferencesInStorage(
          domain.categories.map((category) => category.id)
        );
        postCookieConsent({
          consentAccepted,
          consentRejected: [],
          categoriesAccepted: domain.categories.map((category) => category.id),
          categoriesRejected: [],
          eventType: apiEventTypes.accept,
        });
        hideBanner();
      }
      if (e.target?.id === "lb-cookie-consent-reject-all") {
        const {
          cookiesAccepted,
          cookiesRejected,
          categoriesAccepted,
          categoriesRejected,
          domainsAccepted,
        } = getConsentData();
        setLbCookies({
          name: LB_LOCAL_STORAGE_KEY,
          value: { whiteList: domainsAccepted },
          shareCookies: domain.shareConsent,
        });

        savePreferencesInStorage([]);
        postCookieConsent({
          consentAccepted: cookiesAccepted.map((c) => c.name),
          consentRejected: cookiesRejected.map((c) => c.name),
          categoriesAccepted: categoriesAccepted.map((c) => c.id),
          categoriesRejected: categoriesRejected.map((c) => c.id),
          eventType: apiEventTypes.reject,
        });
        hideBanner();
      }
      if (e.target?.id === "lb-cookie-consent-do-not-sell") {
        const {
          cookiesAccepted,
          cookiesRejected,
          categoriesAccepted,
          categoriesRejected,
          domainsAccepted,
          domainsRejected,
        } = getConsentData({ isDoNotSell: true });
        setLbCookies({
          name: LB_LOCAL_STORAGE_KEY,
          value: { whiteList: domainsAccepted, blackList: domainsRejected },
          shareCookies: domain.shareConsent,
        });
        domainsAccepted.forEach((domain) => unblockSources(new RegExp(domain)));

        savePreferencesInStorage(categoriesAccepted.map((c) => c.id));
        postCookieConsent({
          consentAccepted: cookiesAccepted.map((c) => c.name),
          consentRejected: cookiesRejected.map((c) => c.name),
          categoriesAccepted: categoriesAccepted.map((c) => c.id),
          categoriesRejected: categoriesRejected.map((c) => c.id),
          eventType: apiEventTypes.doNotSell,
        });
        hideBanner();
      }
      if (e.target?.id === "lb-cookie-consent-save-preferences") {
        const {
          cookiesAccepted,
          cookiesRejected,
          categoriesAccepted,
          categoriesRejected,
          domainsAccepted,
          domainsRejected,
        } = getConsentData({ isSavePreferences: true });

        setLbCookies({
          name: LB_LOCAL_STORAGE_KEY,
          value: { whiteList: domainsAccepted, blackList: domainsRejected },
          shareCookies: domain.shareConsent,
        });
        domainsAccepted.forEach((domain) => unblockSources(new RegExp(domain)));

        savePreferencesInStorage(categoriesAccepted.map((c) => c.id));
        postCookieConsent({
          consentAccepted: cookiesAccepted.map((c) => c.name),
          consentRejected: cookiesRejected.map((c) => c.name),
          categoriesAccepted: categoriesAccepted.map((c) => c.id),
          categoriesRejected: categoriesRejected.map((c) => c.id),
          eventType: apiEventTypes.customize,
        });
        hideBanner();
      }
      if (
        e.target?.id === "lb-cookie-consent-open-preferences" ||
        e.target?.closest(".lb-floating-btn")?.id === "lb-floating-btn"
      ) {
        document
          .querySelector(".cookie-consent-banner-container")
          ?.classList.add("hidden");
        document
          .querySelector(".cookie-consent-banner-preferences")
          ?.classList.remove("hidden");
      }
      if (e.target?.classList.contains("lb-preferences-center-trigger")) {
        /* Show preferences center on click of trigger button */
        document
          .getElementById("cookie-consent-banner-preferences")
          ?.classList.remove("hidden");
      }
      if (e.target?.closest(".lb-preferences-banner-close-icon")) {
        /* Hide preferences center on click of close button */
        hideBanner();
      }

      if (e.target.closest(".lb-switch")) {
        const container = e.target.closest(".lb-switch");

        const categoryId = container?.getAttribute("data-category-id");
        const isChecked = container?.querySelector(".lb-switch-input")?.checked;
        const category = document.getElementById(categoryId);

        if (isChecked) {
          category?.classList.add("accepted");
        } else {
          category?.classList.remove("accepted", "expanded");
        }
        return;
      }

      if (e.target?.closest(".category")) {
        const category = e.target?.closest(".category");
        Array.from(category?.classList).includes("expanded")
          ? category.classList.remove("expanded")
          : category.classList.add("expanded");
      }
    });

    window.lb = {
      showPreferencesCenter: function () {
        document
          .querySelector(".cookie-consent-banner-preferences")
          .classList.remove("hidden");
      },
    };
  };

  // renderers
  const renderCheckbox = ({
    id = "",
    label = "",
    checked = false,
    disabled = false,
  }) => {
    return `\
      <label \
        class="lb-checkbox-container lb-switch ${disabled ? "disabled" : ""}"\
        data-category-id="${id}"\
      >\
        ${label}\
        <input \
          class="lb-checkbox-input lb-switch-input" \
          type="checkbox"\
          id="checkbox-${id}"\
          ${checked ? "checked" : ""}\
          ${disabled ? "disabled" : ""}\
        >
        <span class="lb-checkbox-mark"></span>\
      </label>`;
  };

  const renderToggle = ({
    id = "",
    label = "",
    checked = false,
    disabled = false,
  }) => {
    return `\
      <div class="lb-toggle-container lb-switch" \
          data-category-id="${id}" \
          ${disabled ? `title="This category cannot be opted out of."` : ""}\
      >
        <input \
          class="lb-toggle-input lb-switch-input"
          type="checkbox" \
          id="checkbox-${id}" \
          ${checked ? "checked" : ""}\
          ${disabled ? "disabled" : ""}\
        />\
        <label \
          class="lb-toggle-label ${disabled ? "disabled" : ""}"\
          for="checkbox-${id}"\
        >\
          ${label}\
        </label>\
      </div>`;
  };

  const renderBanner = (banner, showPreferencesOnly = false) => {
    if (!banner) return;

    const btnCustomize = `\
      <button\
        id="lb-cookie-consent-open-preferences"\
        class="btn customize"\
        style="background-color: #${banner?.layout.banner?.actionButton?.backgroundColor};\
        color: #${banner?.layout.banner?.actionButton?.color};\
        border-color: #${banner?.layout.banner?.actionButton?.borderColor};"\
      >\
        ${banner?.layout.banner?.actionButton?.text}\
      </button>`;

    const btnReject = `\
      <button\
        id="lb-cookie-consent-reject-all"\
        class="btn reject"\
        style="background-color: #${banner?.layout.banner?.rejectAllButton?.backgroundColor};\
        color: #${banner?.layout.banner?.rejectAllButton?.color};\
        border-color: #${banner?.layout.banner?.rejectAllButton?.borderColor};"\
      >\
        ${banner?.layout.banner?.rejectAllButton?.text}\
      </button>`;

    const btnAccept = `\
      <button\
        id="lb-cookie-consent-accept-all"\
        class="btn accept"\
        style="background-color: #${banner?.layout.banner?.acceptAllButton?.backgroundColor};\
        color: #${banner?.layout.banner?.acceptAllButton?.color};\
        border-color: #${banner?.layout.banner?.acceptAllButton?.borderColor};"\
      >\
        ${banner?.layout.banner?.acceptAllButton?.text}\
      </button>`;

    const btnDoNotSell = `\
      <button\
        id="lb-cookie-consent-do-not-sell"\
        class="btn do-not-sell"\
        style="background-color: #${banner?.layout.banner?.doNotSellButton?.backgroundColor};\
        color: #${banner?.layout.banner?.doNotSellButton?.color};\
        border-color: #${banner?.layout.banner?.doNotSellButton?.borderColor};"\
      >\
        ${banner?.layout.banner?.doNotSellButton?.text}\
      </button>`;

    const policyUrl = banner?.layout.banner?.policyUrl
      ? `<a
            class="policy-link"
            href="${banner?.layout.banner?.policyUrl}"
            rel="noreferrer"
            target="_blank"
            style="color: #${banner?.layout?.banner?.policyTextColor};"\
          >
            ${banner?.layout.banner?.policy}
          </a>`
      : ``;

    const htmlBanner = `\
      <div class="\
            cookie-consent-banner-container \
            ${banner?.layout.type} \
            ${banner?.layout.position?.join(" ")} \
            ${!banner.showBanner || showPreferencesOnly ? " hidden" : ""} \
            ${isMobile() ? " mobile-view" : ""} \
        "
        id="lb-cookie-consent-banner">\
        <div class="overlay"></div>
        <div \
          class="main-banner"\
          style="background-color: #${banner?.layout.banner?.backgroundColor};\
                 border-color: #${banner?.layout.banner?.borderColor};"\
        >\
        <div class="main-banner-wrapper">
          <div class="main-banner-body">\
            <div\
              class="policy-text lb-scrollbar"\
              style="color: #${banner?.layout?.banner?.bodyTextColor};"\
            >\
              ${banner?.layout.banner?.body}\
            </div>\
            ${policyUrl}\
          </div>\
          <div class="buttons">\
            ${banner.customizable ? btnCustomize : ""}\
            ${!!banner.linkDoNotSell ? btnDoNotSell : ""}\
            ${
              showButton({
                buttonName: "reject",
                consentType: banner.consentType,
              })
                ? btnReject
                : ""
            }\
            ${
              showButton({
                buttonName: "accept",
                consentType: banner.consentType,
              })
                ? btnAccept
                : ""
            }\
          </div>\
          </div>
        </div>\
      </div>
    `;

    const isBannerInDom = document.getElementById("lb-cookie-consent-banner");
    if (!isBannerInDom) {
      document.body.insertAdjacentHTML("beforeend", htmlBanner);
    }
  };

  const renderPreferences = async (banner, showPreferencesOnly) => {
    const categories = domain.categories;

    /* Check if saved preferences present in Local Storage */
    let savedPreferences = getLbCookies(LB_LOCAL_STORAGE_PREFERENCES_KEY);
    /* If not in Local Storage, GET from API */
    if (!savedPreferences) {
      try {
        savedPreferences = await fetchPreferences();
      } catch (e) {
        savedPreferences = {};
      }
    }

    const htmlDescription = `\
      <div\
        class="description"\
        style="color: #${banner?.layout.preferences?.bodyTextColor};"\
      >\
        ${banner?.layout?.preferences?.body}\
      </div>
    `;

    const btnReject = `\
      <button\
        id="lb-cookie-consent-reject-all"\
        class="btn reject"\
        style="background-color: #${banner?.layout?.preferences?.rejectAllButton?.backgroundColor};\
        color: #${banner?.layout.preferences?.rejectAllButton?.color};\
        border-color: #${banner?.layout.preferences?.rejectAllButton?.borderColor};"\
      >\
        ${banner?.layout.preferences?.rejectAllButton?.text}\
      </button>`;

    const btnAccept = `\
      <button\
        id="lb-cookie-consent-accept-all"\
        class="btn accept"\
        style="background-color: #${banner?.layout.preferences?.acceptAllButton?.backgroundColor};\
        color: #${banner?.layout.preferences?.acceptAllButton?.color};\
        border-color: #${banner?.layout.preferences?.acceptAllButton?.borderColor};"\
      >\
        ${banner?.layout.preferences?.acceptAllButton?.text}\
      </button>`;

    const btnSavePreferences = `\
      <button\
        id="lb-cookie-consent-save-preferences"\
        class="btn customize"\
        style="background-color: #${banner?.layout?.preferences?.actionButton?.backgroundColor};\
        color: #${banner?.layout.preferences?.actionButton?.color};\
        border-color: #${banner?.layout.preferences?.actionButton?.borderColor};"\
      >\
        ${banner?.layout.preferences?.actionButton?.text}\
      </button>`;

    const btnDoNotSell = `\
      <button\
        id="lb-cookie-consent-do-not-sell"\
        class="btn do-not-sell"\
        style="background-color: #${banner?.layout.preferences?.doNotSellButton?.backgroundColor};\
        color: #${banner?.layout.preferences?.doNotSellButton?.color};\
        border-color: #${banner?.layout.preferences?.doNotSellButton?.borderColor};"\
      >\
        ${banner?.layout.preferences?.doNotSellButton?.text}\
      </button>`;

    const getCookieHtml = (cookie) => {
      const cookieDescription = `\
      <div class="lb-row">\
        <div class="label">Cookie Description:</div>
        <div class="value">${cookie.description}</div>
      </div>`;

      return `\
          <div class="category-cookie">\
            <div class="lb-row">\
              <div class="label">Cookie Name:</div>
              <div class="value">${cookie.name}</div>
            </div>\
            ${cookie.description ? cookieDescription : ""}\
            <div class="lb-row">\
              <div class="label">Expires:</div>
              <div class="value">${getPrettyExpires(cookie.expires)}</div>
            </div>\
          </div>`;
    };

    const getCategoryHtml = (category) => {
      const showToggle =
        banner?.layout?.preferences?.category?.checkboxType === "toggle";

      const payload = {
        id: category.id,
        checked:
          savedPreferences?.categoriesAccepted?.includes(category.id) ||
          !category.optOut,
        disabled: !category.optOut,
      };

      const categoryCookies = domain.cookies.filter(
        (c) => c.cookieCategoryId === category.id
      );

      var SVG_CARET_RIGHT = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="#${banner?.layout?.preferences?.category?.colorTitle}" viewBox="0 0 256 256"><rect width="256" height="256" fill="none"></rect><polyline points="96 48 176 128 96 208" fill="none" stroke="#${banner?.layout?.preferences?.category?.colorTitle}" stroke-linecap="round" stroke-linejoin="round" stroke-width="24"></polyline></svg>`;
      const htmlCaret = `<div class="icon-box">${SVG_CARET_RIGHT}</div>`;
      const htmlDescription = `<div class="lb-row category-description" style="color: #${banner?.layout?.preferences?.category?.colorDescription}">${category?.description}</div>`;

      const html = `\
      <div class="category ${payload.checked ? "accepted" : ""}" id="${
        category.id
      }">\
        <div class="lb-row category-name">\
          <div\
            class="title"\
            style="color: #${
              banner?.layout?.preferences?.category?.colorTitle
            };"\
          >\
            ${category?.name}\
            ${categoryCookies.length ? htmlCaret : ""}\
          </div>\
          ${showToggle ? renderToggle(payload) : renderCheckbox(payload)}
        </div>\
        ${category?.description ? htmlDescription : ""}
        <div class="category-cookies">\
          ${categoryCookies?.map((c) => getCookieHtml(c))?.join("") || ""}\
        </div>\
      </div>\
      `;
      return html;
    };

    const htmlCookieCategories = `\
      <div class="cookie-categories lb-scrollbar">\
        ${categories?.map((c) => getCategoryHtml(c))?.join("") || ""}\
      </div>`;

    let cssClasses = "cookie-consent-banner-preferences lb-scrollbar ";
    if (!showPreferencesOnly) cssClasses += " hidden";
    if (isMobile()) cssClasses += " mobile-view";

    const htmlPreferences = `\
      <div \
        class="${cssClasses}" \
        id="cookie-consent-banner-preferences">\
          <div class="overlay"></div>\
          <div class="cookie-consent-banner-preferences-wrapper">
            <div class="lb-banner-header-wrapper">
              <div\
                class="banner-header"\
                style="color: #${banner?.layout.preferences?.titleTextColor};"\
              >
                ${banner?.layout?.preferences?.title}\
              </div>\
              <span class="lb-preferences-banner-close-icon">\
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="#333" viewBox="0 0 256 256">\
                  <rect width="256" height="256" fill="none"></rect>\
                  <line x1="200" y1="56" x2="56" y2="200" stroke="#333" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></line>\
                  <line x1="200" y1="200" x2="56" y2="56" stroke="#333" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></line>\
                </svg>\
              </span>
            </div>
            <div class="preferences-banner-body lb-scrollbar">\
              ${banner?.layout?.preferences?.body ? htmlDescription : ""}\
              ${categories?.length ? htmlCookieCategories : ""}\
            </div>
            <div class="buttons">
              ${!!banner.linkDoNotSell ? btnDoNotSell : ""}\
              ${
                showButton({
                  buttonName: "reject",
                  consentType: banner.consentType,
                })
                  ? btnReject
                  : ""
              }\
              ${
                showButton({
                  buttonName: "accept",
                  consentType: banner.consentType,
                })
                  ? btnAccept
                  : ""
              }\
              ${btnSavePreferences}\
            </div>
            ${
              enableLightbeamBranding
                ? `<a href="https://www.lightbeam.ai/" target="_blank" class="lb-powered-by-container">
                      <p class="lb-powered-by-text">Powered by</p>
                      <img src="https://lb-common.s3.ap-south-1.amazonaws.com/lb-logo.png" alt="lb-logo" class="lb-powered-by-logo" />
                    </a>`
                : ""
            }
      </div>\
    </div>\
    `;

    const isBannerInDom = document.getElementById(
      "cookie-consent-banner-preferences"
    );
    if (!isBannerInDom) {
      document.body.insertAdjacentHTML("beforeend", htmlPreferences);
    }
  };

  const renderFloatingButton = (isVisible = false, domain) => {
    if (!domain.floatingButtonEnabled) return;

    const button = `\
      <button class="lb-floating-btn ${
        isVisible ? "" : "hidden"
      } lb-floating-btn--${domain?.floatingButtonConfig?.style}" style="${
      domain?.floatingButtonConfig?.position === "left" ? "left" : "right"
    }: 60px" id="lb-floating-btn">\
        ${domain?.floatingButtonConfig?.icon}
      </button>`;

    document.body.insertAdjacentHTML("beforeend", button);
  };

  const hideBanner = () => {
    document
      .getElementById("lb-cookie-consent-banner")
      ?.classList.add("hidden");
    document
      .getElementById("cookie-consent-banner-preferences")
      ?.classList.add("hidden");

    if (lbCookieConsent.isLoadedViaGtm) {
      showFloatingButton();
    }
  };

  const showFloatingButton = () => {
    document.getElementById("lb-floating-btn")?.classList.remove("hidden");
  };

  const setCSSVariables = (domain) => {
    const banner = domain.banner;

    const style = document.createElement("style");

    const floatingBtnStyle = domain.floatingButtonEnabled
      ? `--lb-floating-btn-color: #${
          domain?.floatingButtonConfig?.color || "000000"
        };`
      : "";

    style.textContent = `
      :root {
        --lb-checkbox-color-always-on: #${
          banner?.layout?.preferences?.category?.checkboxColorAlwaysOn ||
          "D1D5DA"
        };
        --lb-checkbox-color-on: #${
          banner?.layout?.preferences?.category?.checkboxColorOn || "333333"
        };
        --lb-checkbox-color-off: #${
          banner?.layout?.preferences?.category?.checkboxColorOff || "FFFFFF"
        };
        --lb-checkbox-check-mark-color: #${
          banner?.layout?.preferences?.category?.checkboxCheckMarkColor ||
          "FFFFFF"
        };
        ${floatingBtnStyle}
      }`;

    document.head.appendChild(style);
  };

  // blockers / unblockers
  const injectHtml = (domain) => {
    const item = getLbCookies(LB_LOCAL_STORAGE_KEY);
    setCSSVariables(domain);
    renderPreferences(domain.banner);

    // render floating pref center button if script loaded via GTM
    if (lbCookieConsent.isLoadedViaGtm) {
      renderFloatingButton(
        (isVisible = !!(item || lbCookieConsent.isPrefCenterOnly)),
        domain
      );
    }

    // show banner if there is no saved user preferences
    if (!item) {
      renderBanner(domain.banner, showPreferences);
    }
  };

  // init
  const essentialsWhiteList = getLbEssentialsWhiteList();

  const init = () => {
    if (domain) {
      injectHtml(domain);
      initHandlers(domain);
      enableEssentials(); // unblock essentials on page change
      updateScriptSettings(domain);
    } else {
      setTimeout(() => init(), 100);
    }
  };

  domain = await fetchDomainInfo();
  init();

  window.navigation.addEventListener("navigate", () => {
    init();
  });
};
